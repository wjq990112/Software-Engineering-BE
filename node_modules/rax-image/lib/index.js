"use strict";

exports.__esModule = true;
exports.default = void 0;

var _rax = require("rax");

var _universalEnv = require("universal-env");

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

var __rest = void 0 && (void 0).__rest || function (s, e) {
  var t = {};

  for (var p in s) {
    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];
  }

  if (s != null && typeof Object.getOwnPropertySymbols === "function") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];
  }
  return t;
};

var Image = (0, _rax.forwardRef)(function (props, ref) {
  var _useState = (0, _rax.useState)(props.source),
      source = _useState[0],
      setSource = _useState[1];

  var isInitialMount = (0, _rax.useRef)(false);

  var onError = function (e) {
    var fallbackSource = props.fallbackSource,
        _props$onError = props.onError,
        onError = _props$onError === void 0 ? function () {} : _props$onError;

    if (fallbackSource && fallbackSource.uri && source.uri !== fallbackSource.uri) {
      setSource(fallbackSource);
    }

    onError(e);
  };

  var onLoad = function (e) {
    var _props$onLoad = props.onLoad,
        onLoad = _props$onLoad === void 0 ? function () {} : _props$onLoad;

    if (typeof e.success !== 'undefined') {
      if (e.success) {
        onLoad(e);
      } else {
        onError(e);
      }
    } else if (typeof e.currentTarget !== 'undefined') {
      if (e.currentTarget.naturalWidth > 1 && e.currentTarget.naturalHeight > 1) {
        onLoad(e);
      } else {
        onError(e);
      }
    }
  };

  (0, _rax.useEffect)(function () {
    if (!isInitialMount.current) {
      isInitialMount.current = true;
    } else {
      setSource(props.source);
    }
  }, [props.source.uri]);
  var nativeProps = Object.assign({}, props); // Source must a object

  if (source && source.uri) {
    var _nativeProps$style = nativeProps.style,
        style = _nativeProps$style === void 0 ? {} : _nativeProps$style;
    var width = source.width,
        height = source.height,
        uri = source.uri;
    nativeProps.style = Object.assign({
      width: width,
      height: height
    }, style);
    nativeProps.src = uri;
    nativeProps.onLoad = onLoad;
    nativeProps.onError = onError;
    delete nativeProps.source; // for cover and contain

    var resizeMode = nativeProps.resizeMode || nativeProps.style.resizeMode;

    if (resizeMode) {
      if (_universalEnv.isWeex) {
        nativeProps.resize = resizeMode;
        nativeProps.style.resizeMode = resizeMode;
      } else {
        nativeProps.style.objectFit = resizeMode;
      }
    }

    var className = nativeProps.className,
        children = nativeProps.children,
        nativeStyle = nativeProps.style,
        otherProps = __rest(nativeProps, ["className", "children", "style"]);

    var cls = ['rax-image', className].join(' ');
    return _universalEnv.isWeex ? (0, _rax.createElement)("image", _extends({
      ref: ref,
      className: cls,
      style: nativeStyle
    }, otherProps)) : (0, _rax.createElement)("img", _extends({
      ref: ref,
      className: cls,
      style: nativeStyle
    }, otherProps));
  }

  return null;
});
var _default = Image;
exports.default = _default;